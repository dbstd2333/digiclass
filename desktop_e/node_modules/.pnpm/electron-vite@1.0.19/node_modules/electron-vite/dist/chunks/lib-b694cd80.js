'use strict';

var vite = require('vite');
var colors = require('picocolors');
var config = require('./lib-ddb42891.js');
require('node:path');
require('node:fs');
require('node:url');
require('node:module');
require('esbuild');
require('node:child_process');
require('node:fs/promises');
require('magic-string');
require('node:crypto');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var colors__default = /*#__PURE__*/_interopDefaultLegacy(colors);

async function createServer(inlineConfig = {}) {
    var _a, _b, _c;
    process.env.NODE_ENV_ELECTRON_VITE = 'development';
    const config$1 = await config.resolveConfig(inlineConfig, 'serve', 'development');
    if (config$1.config) {
        const logger = vite.createLogger(inlineConfig.logLevel);
        let server;
        let ps;
        const mainViteConfig = (_a = config$1.config) === null || _a === void 0 ? void 0 : _a.main;
        if (mainViteConfig) {
            const watchHook = () => {
                logger.info(colors__default["default"].green(`\nrebuild the electron main process successfully`));
                if (ps) {
                    logger.info(colors__default["default"].cyan(`\n  waiting for electron to exit...`));
                    ps.removeAllListeners();
                    ps.kill();
                    ps = config.startElectron(inlineConfig.root, logger);
                    logger.info(colors__default["default"].green(`\nrestart electron app...`));
                }
            };
            await doBuild(mainViteConfig, watchHook);
            logger.info(colors__default["default"].green(`\nbuild the electron main process successfully`));
        }
        const preloadViteConfig = (_b = config$1.config) === null || _b === void 0 ? void 0 : _b.preload;
        if (preloadViteConfig) {
            logger.info(colors__default["default"].gray(`\n-----\n`));
            const watchHook = () => {
                logger.info(colors__default["default"].green(`\nrebuild the electron preload files successfully`));
                if (server) {
                    logger.info(colors__default["default"].cyan(`\n  trigger renderer reload`));
                    server.ws.send({ type: 'full-reload' });
                }
            };
            await doBuild(preloadViteConfig, watchHook);
            logger.info(colors__default["default"].green(`\nbuild the electron preload files successfully`));
        }
        const rendererViteConfig = (_c = config$1.config) === null || _c === void 0 ? void 0 : _c.renderer;
        if (rendererViteConfig) {
            logger.info(colors__default["default"].gray(`\n-----\n`));
            server = await vite.createServer(rendererViteConfig);
            if (!server.httpServer) {
                throw new Error('HTTP server not available');
            }
            await server.listen();
            const conf = server.config.server;
            const protocol = conf.https ? 'https:' : 'http:';
            const host = config.resolveHostname(conf.host);
            const port = conf.port;
            process.env.ELECTRON_RENDERER_URL = `${protocol}//${host}:${port}`;
            const slogger = server.config.logger;
            slogger.info(colors__default["default"].green(`dev server running for the electron renderer process at:\n`), {
                clear: !slogger.hasWarned
            });
            server.printUrls();
        }
        ps = config.startElectron(inlineConfig.root, logger);
        logger.info(colors__default["default"].green(`\nstart electron app...`));
    }
}
async function doBuild(config, watchHook) {
    return new Promise(resolve => {
        var _a;
        if ((_a = config.build) === null || _a === void 0 ? void 0 : _a.watch) {
            let firstBundle = true;
            const closeBundle = () => {
                if (firstBundle) {
                    firstBundle = false;
                    resolve();
                }
                else {
                    watchHook();
                }
            };
            config = vite.mergeConfig(config, {
                plugins: [
                    {
                        name: 'vite:electron-watcher',
                        closeBundle
                    }
                ]
            });
        }
        vite.build(config).then(() => {
            var _a;
            if (!((_a = config.build) === null || _a === void 0 ? void 0 : _a.watch)) {
                resolve();
            }
        });
    });
}

exports.createServer = createServer;
